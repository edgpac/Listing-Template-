<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIR Property Flyer Editor - Enhanced</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            padding: 0;
            background: #f0f0f0;
        }

        .flyer-container {
            background: white;
            width: 8.5in;
            min-height: 11in;
            margin: 20px auto;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
        }

        .hero-image-section {
            position: relative;
            height: 500px;
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
        }

        .hero-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .logo img {
            height: 48px;
        }

        .content-section {
            padding: 25px 30px 10px 30px;
        }

        .interior-image {
            width: 100%;
            height: 185px;
            object-fit: cover;
            object-position: center;
            border-radius: 8px;
        }

        .amenities-section {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 12px 30px 8px 30px;
            border-top: 1px solid #e5e7eb;
            margin-top: 10px;
            gap: 60px;
        }

        .amenity-item {
            text-align: center;
            color: #4b5563;
        }

        .amenity-icon {
            font-size: 22px;
            color: #1e3a8a;
            margin-bottom: 3px;
        }

        .amenity-value {
            font-size: 22px;
            font-weight: 700;
            color: #1e3a8a;
            margin-bottom: 1px;
        }

        .amenity-label {
            font-size: 8px;
            text-transform: uppercase;
            letter-spacing: 0.2px;
            color: #6b7280;
        }

        .footer-note {
            background: #1e3a8a;
            color: white;
            padding: 10px 20px;
            font-size: 9px;
            text-align: center;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
        }

        .edit-field {
            border: 1px dashed #cbd5e1;
            padding: 4px 8px;
            border-radius: 4px;
            background: transparent;
            width: 100%;
            outline: none;
            transition: all 0.2s;
        }

        .edit-field:focus {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.05);
        }

        .edit-field-white {
            color: white;
        }

        .edit-field-dark {
            color: #1f2937;
        }

        .image-upload-btn {
            cursor: pointer;
            position: relative;
            overflow: hidden;
            display: block;
            background: #f3f4f6;
        }

        .image-upload-btn img {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
        }

        .upload-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }

        .image-upload-btn:hover .upload-overlay {
            opacity: 1;
        }

        /* Drag and Drop Styles */
        .drag-over {
            border: 3px dashed #3b82f6 !important;
            background: rgba(59, 130, 246, 0.1) !important;
        }

        .drag-over .upload-overlay {
            opacity: 1 !important;
            background: rgba(59, 130, 246, 0.2) !important;
        }

        .controls-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            z-index: 1000;
            width: 240px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            overflow-x: hidden;
        }

        .controls-panel::-webkit-scrollbar {
            width: 8px;
        }

        .controls-panel::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .controls-panel::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .controls-panel::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .btn {
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            width: 100%;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #10b981;
            color: white;
        }

        .btn-secondary:hover {
            background: #059669;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @media print {
            .controls-panel {
                display: none;
            }
            .flyer-container {
                box-shadow: none;
                margin: 0;
            }
            .edit-field {
                border: none;
            }
            .remove-icon-btn {
                display: none !important;
            }
            .upload-overlay {
                display: none !important;
            }
        }

        .clean-view .edit-field {
            border: none !important;
            background: transparent !important;
            pointer-events: none;
        }

        .clean-view .remove-icon-btn {
            display: none !important;
        }

        .clean-view .upload-overlay {
            display: none !important;
        }

        .clean-view input,
        .clean-view textarea {
            overflow: visible !important;
            text-overflow: clip !important;
        }

        .clean-view .character-counter {
            display: none !important;
        }

        .unit-overview-section {
            background: #f9fafb;
            padding: 12px;
            border-radius: 8px;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        .unit-overview-section textarea {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        textarea.edit-field {
            resize: vertical;
            min-height: 80px;
            font-family: 'Montserrat', sans-serif;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }

        .features-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e5e7eb;
        }

        .feature-icon-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 10px;
        }

        .feature-icon-item {
            position: relative;
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .feature-icon-item:hover {
            background: #e5e7eb;
            border-color: #3b82f6;
        }

        .feature-icon-item.add-icon {
            background: #eff6ff;
            border: 2px dashed #3b82f6;
            color: #3b82f6;
        }

        .feature-icon-item.add-icon:hover {
            background: #dbeafe;
        }

        .feature-icon-display {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .feature-icon-label {
            font-size: 9px;
            color: #6b7280;
            text-transform: uppercase;
        }

        .remove-icon-btn {
            position: absolute;
            top: -6px;
            right: -6px;
            background: #3b82f6;
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            z-index: 10;
            transition: all 0.2s;
        }

        .remove-icon-btn:hover {
            background: #2563eb;
            transform: scale(1.1);
        }

        .amenity-item .remove-icon-btn {
            background: #3b82f6;
        }

        .amenity-item .remove-icon-btn:hover {
            background: #2563eb;
        }

        .feature-icon-item .remove-icon-btn {
            background: #ef4444;
        }

        .feature-icon-item .remove-icon-btn:hover {
            background: #dc2626;
        }

        .icon-selector-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .icon-selector-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .icon-option {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 5px;
        }

        .icon-option:hover {
            background: #f3f4f6;
        }

        .icon-option i {
            font-size: 24px;
            margin-right: 15px;
            color: #3b82f6;
        }

        /* Collapsible Section Styles */
        .collapsible-section {
            margin-bottom: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }

        .collapsible-header {
            background: #f9fafb;
            padding: 10px 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
            user-select: none;
        }

        .collapsible-header:hover {
            background: #f3f4f6;
        }

        .collapsible-header-title {
            font-size: 12px;
            font-weight: 600;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .collapsible-header-icon {
            font-size: 10px;
            color: #6b7280;
            transition: transform 0.2s;
        }

        .collapsible-header-icon.open {
            transform: rotate(180deg);
        }

        .collapsible-content {
            padding: 12px;
            background: white;
        }

        /* Auto-save indicator */
        .autosave-indicator {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1001;
            transition: all 0.3s;
        }

        .autosave-indicator.saving {
            background: #fef3c7;
            color: #92400e;
        }

        .autosave-indicator.saved {
            background: #d1fae5;
            color: #065f46;
        }

        .autosave-indicator.error {
            background: #fee2e2;
            color: #991b1b;
        }

        /* QR Code Section */
        .qr-code-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        #qr-code {
            display: flex;
            justify-content: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }

        #qr-code canvas {
            max-width: 100% !important;
            height: auto !important;
        }

        #qr-code-flyer {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #qr-code-flyer canvas {
            max-width: 60px !important;
            max-height: 60px !important;
            height: auto !important;
            width: auto !important;
        }

        /* Keyboard shortcuts help */
        .shortcuts-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .shortcuts-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .shortcut-key {
            background: #f3f4f6;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            font-weight: 600;
        }

        /* Template preset styles */
        .preset-item {
            background: #f9fafb;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
        }

        .preset-item:hover {
            background: #f3f4f6;
        }

        .preset-actions {
            display: flex;
            gap: 4px;
        }

        .preset-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .preset-btn:hover {
            background: #e5e7eb;
        }

        /* History controls */
        .history-controls {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
        }

        .history-btn {
            flex: 1;
            padding: 6px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        /* Batch export progress */
        .batch-export-progress {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 2001;
            min-width: 300px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 12px;
        }

        .progress-bar-fill {
            height: 100%;
            background: #3b82f6;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, useCallback } = React;

        // Auto-save hook
        function useAutoSave(data, delay = 2000) {
            const [saveStatus, setSaveStatus] = useState('saved'); // 'saved', 'saving', 'error'
            const timeoutRef = useRef(null);

            useEffect(() => {
                if (timeoutRef.current) {
                    clearTimeout(timeoutRef.current);
                }

                setSaveStatus('saving');
                timeoutRef.current = setTimeout(() => {
                    try {
                        localStorage.setItem('flyer-autosave', JSON.stringify({
                            data,
                            timestamp: Date.now()
                        }));
                        setSaveStatus('saved');
                    } catch (error) {
                        console.error('Auto-save failed:', error);
                        setSaveStatus('error');
                    }
                }, delay);

                return () => {
                    if (timeoutRef.current) {
                        clearTimeout(timeoutRef.current);
                    }
                };
            }, [data, delay]);

            return saveStatus;
        }

        // Undo/Redo hook
        function useHistory(initialState) {
            const [index, setIndex] = useState(0);
            const [history, setHistory] = useState([initialState]);

            const setState = useCallback((newState) => {
                setHistory(prev => {
                    const newHistory = prev.slice(0, index + 1);
                    newHistory.push(newState);
                    // Limit history to 50 states
                    if (newHistory.length > 50) {
                        newHistory.shift();
                        return newHistory;
                    }
                    return newHistory;
                });
                setIndex(prev => Math.min(prev + 1, 49));
            }, [index]);

            const undo = useCallback(() => {
                if (index > 0) {
                    setIndex(index - 1);
                }
            }, [index]);

            const redo = useCallback(() => {
                if (index < history.length - 1) {
                    setIndex(index + 1);
                }
            }, [index, history.length]);

            const canUndo = index > 0;
            const canRedo = index < history.length - 1;

            return {
                state: history[index],
                setState,
                undo,
                redo,
                canUndo,
                canRedo
            };
        }

        function PropertyFlyerEditor() {
            const initialData = {
                mls: '24-2325',
                address: '605B, BAHIA DEL TEZAL',
                priceUSD: '289,000',
                priceMXN: '5,780,000',
                size: '986.69',
                yearBuilt: '2017',
                overview: 'This unit completely updated with new kitchen and updated furniture. Great ocean views from the patio.',
                location: 'Cabo Corridor',
                bedrooms: '2',
                fullBaths: '2',
                halfBaths: '0',
                garageSpaces: '2',
                swimmingPools: '1',
                heroImage: null,
                logo: 'https://res.cloudinary.com/dhwnr1pa5/image/upload/v1762021536/Screenshot_2025-10-31_at_5.21.25_PM-removebg-preview_2_gndt9y.png',
                logoHeight: 38,
                logoWidth: 110,
                image1: null,
                image2: null,
                image3: null,
                image4: null,
                qrCodeUrl: '',
                qrCodeLabel: 'Scan Listing'
            };

            // Try to load autosaved data
            const loadAutoSave = () => {
                try {
                    const saved = localStorage.getItem('flyer-autosave');
                    if (saved) {
                        const { data, timestamp } = JSON.parse(saved);
                        const age = Date.now() - timestamp;
                        // Load if less than 24 hours old
                        if (age < 24 * 60 * 60 * 1000) {
                            return data;
                        }
                    }
                } catch (error) {
                    console.error('Failed to load autosave:', error);
                }
                return initialData;
            };

            const { state: propertyData, setState: setPropertyData, undo, redo, canUndo, canRedo } = useHistory(loadAutoSave());
            
            const [customFeatures, setCustomFeatures] = useState([]);
            const [showIconSelector, setShowIconSelector] = useState(false);
            const [amenityIcons, setAmenityIcons] = useState([
                { id: 'bedrooms', icon: 'fa-bed', label: 'Bedrooms', value: '2' },
                { id: 'fullBaths', icon: 'fa-bath', label: 'Full Baths', value: '2' },
                { id: 'halfBaths', icon: 'fa-toilet', label: 'Â½ Bath', value: '0' },
                { id: 'garageSpaces', icon: 'fa-car', label: 'Garage Space', value: '2' },
                { id: 'swimmingPools', icon: 'fa-swimming-pool', label: 'Swimming Pool', value: '1' }
            ]);
            const [showAmenityIconSelector, setShowAmenityIconSelector] = useState(false);
            const [editingAmenityIndex, setEditingAmenityIndex] = useState(null);
            const [isCleanView, setIsCleanView] = useState(false);
            
            // UI State
            const [expandedSections, setExpandedSections] = useState({
                logo: true,
                export: true,
                features: false,
                qr: false,
                presets: false
            });
            const [showShortcuts, setShowShortcuts] = useState(false);
            const [presets, setPresets] = useState([]);
            const [batchExporting, setBatchExporting] = useState(false);
            const [batchProgress, setBatchProgress] = useState(0);

            const saveStatus = useAutoSave(propertyData);

            const availableIcons = [
                { icon: 'fa-wifi', label: 'WiFi' },
                { icon: 'fa-snowflake', label: 'A/C' },
                { icon: 'fa-fire', label: 'Heating' },
                { icon: 'fa-utensils', label: 'Kitchen' },
                { icon: 'fa-tv', label: 'TV' },
                { icon: 'fa-dumbbell', label: 'Gym' },
                { icon: 'fa-hot-tub', label: 'Hot Tub' },
                { icon: 'fa-umbrella-beach', label: 'Beach Access' },
                { icon: 'fa-door-open', label: 'Balcony' },
                { icon: 'fa-paw', label: 'Pet Friendly' },
                { icon: 'fa-wheelchair', label: 'Accessible' },
                { icon: 'fa-shield-alt', label: 'Security' },
                { icon: 'fa-elevator', label: 'Elevator' },
                { icon: 'fa-wine-glass', label: 'Bar' },
                { icon: 'fa-coffee', label: 'Coffee Maker' },
                { icon: 'fa-blender', label: 'Blender' },
                { icon: 'fa-couch', label: 'Furnished' },
                { icon: 'fa-sun', label: 'Solar' },
                { icon: 'fa-water', label: 'Ocean View' },
                { icon: 'fa-mountain', label: 'Mountain View' },
                { icon: 'fa-bed', label: 'Bedrooms' },
                { icon: 'fa-bath', label: 'Full Baths' },
                { icon: 'fa-toilet', label: 'Half Bath' },
                { icon: 'fa-car', label: 'Garage' },
                { icon: 'fa-swimming-pool', label: 'Pool' },
                { icon: 'fa-tree', label: 'Garden' },
                { icon: 'fa-home', label: 'Property' },
                { icon: 'fa-key', label: 'Keys' },
                { icon: 'fa-lock', label: 'Secure' },
                { icon: 'fa-chess-board', label: 'Game Room' }
            ];

            const heroImageRef = useRef(null);
            const logoRef = useRef(null);
            const image1Ref = useRef(null);
            const image2Ref = useRef(null);
            const image3Ref = useRef(null);
            const image4Ref = useRef(null);

            // Load presets from localStorage
            useEffect(() => {
                try {
                    const saved = localStorage.getItem('flyer-presets');
                    if (saved) {
                        setPresets(JSON.parse(saved));
                    }
                } catch (error) {
                    console.error('Failed to load presets:', error);
                }
            }, []);

            // Keyboard shortcuts
            useEffect(() => {
                const handleKeyDown = (e) => {
                    // Undo: Ctrl/Cmd + Z
                    if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                        e.preventDefault();
                        undo();
                    }
                    // Redo: Ctrl/Cmd + Shift + Z or Ctrl/Cmd + Y
                    if (((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'z') || 
                        ((e.ctrlKey || e.metaKey) && e.key === 'y')) {
                        e.preventDefault();
                        redo();
                    }
                    // Print: Ctrl/Cmd + P
                    if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
                        e.preventDefault();
                        handlePrint();
                    }
                    // Save: Ctrl/Cmd + S
                    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                        e.preventDefault();
                        // Already auto-saving, just show feedback
                        alert('Auto-save is active! Your work is saved automatically.');
                    }
                    // Toggle clean view: Ctrl/Cmd + E
                    if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                        e.preventDefault();
                        toggleCleanView();
                    }
                    // Show shortcuts: ?
                    if (e.key === '?' && !e.ctrlKey && !e.metaKey) {
                        setShowShortcuts(true);
                    }
                };

                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [undo, redo, canUndo, canRedo]);

            // Generate QR Code
            useEffect(() => {
                if (propertyData.qrCodeUrl && propertyData.qrCodeUrl.trim()) {
                    // QR Code for control panel
                    const qrContainer = document.getElementById('qr-code');
                    if (qrContainer) {
                        qrContainer.innerHTML = '';
                        try {
                            new QRCode(qrContainer, {
                                text: propertyData.qrCodeUrl,
                                width: 120,
                                height: 120,
                                colorDark: '#1e3a8a',
                                colorLight: '#ffffff',
                                correctLevel: QRCode.CorrectLevel.H
                            });
                        } catch (error) {
                            console.error('QR Code generation failed:', error);
                        }
                    }
                    
                    // QR Code for flyer (smaller, next to amenities)
                    const qrFlyerContainer = document.getElementById('qr-code-flyer');
                    if (qrFlyerContainer) {
                        qrFlyerContainer.innerHTML = '';
                        try {
                            new QRCode(qrFlyerContainer, {
                                text: propertyData.qrCodeUrl,
                                width: 60,
                                height: 60,
                                colorDark: '#1e3a8a',
                                colorLight: '#ffffff',
                                correctLevel: QRCode.CorrectLevel.H
                            });
                        } catch (error) {
                            console.error('QR Code flyer generation failed:', error);
                        }
                    }
                }
            }, [propertyData.qrCodeUrl]);

            const handleInputChange = (field, value) => {
                setPropertyData({
                    ...propertyData,
                    [field]: value
                });
            };

            const handleImageUpload = (field, event) => {
                const file = event.target.files[0];
                if (file) {
                    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
                    if (!validTypes.includes(file.type)) {
                        alert('Please select a valid image file (JPG, PNG, or WebP)');
                        return;
                    }
                    
                    const maxSize = 10 * 1024 * 1024;
                    if (file.size > maxSize) {
                        alert('File size too large. Please use images smaller than 10MB.');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        setPropertyData({
                            ...propertyData,
                            [field]: e.target.result
                        });
                    };
                    reader.onerror = () => {
                        alert('Failed to read file. Please try again.');
                    };
                    reader.readAsDataURL(file);
                }
            };

            // Drag and drop handlers
            const handleDragOver = (e) => {
                e.preventDefault();
                e.stopPropagation();
                e.currentTarget.classList.add('drag-over');
            };

            const handleDragLeave = (e) => {
                e.preventDefault();
                e.stopPropagation();
                e.currentTarget.classList.remove('drag-over');
            };

            const handleDrop = (field) => (e) => {
                e.preventDefault();
                e.stopPropagation();
                e.currentTarget.classList.remove('drag-over');
                
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
                    if (!validTypes.includes(file.type)) {
                        alert('Please use JPG, PNG, or WebP images');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        setPropertyData({
                            ...propertyData,
                            [field]: e.target.result
                        });
                    };
                    reader.readAsDataURL(file);
                }
            };

            const triggerFileInput = (ref) => {
                if (ref && ref.current) {
                    ref.current.click();
                }
            };

            const addCustomFeature = (iconData) => {
                if (customFeatures.length < 10) {
                    setCustomFeatures([...customFeatures, iconData]);
                }
                setShowIconSelector(false);
            };

            const removeCustomFeature = (index) => {
                setCustomFeatures(customFeatures.filter((_, i) => i !== index));
            };

            const openIconSelector = () => {
                setShowIconSelector(true);
            };

            const openAmenityIconSelector = (index) => {
                setEditingAmenityIndex(index);
                setShowAmenityIconSelector(true);
            };

            const changeAmenityIcon = (iconData) => {
                const newAmenityIcons = [...amenityIcons];
                newAmenityIcons[editingAmenityIndex] = {
                    ...newAmenityIcons[editingAmenityIndex],
                    icon: iconData.icon,
                    label: iconData.label
                };
                setAmenityIcons(newAmenityIcons);
                setShowAmenityIconSelector(false);
                setEditingAmenityIndex(null);
            };

            const updateAmenityValue = (index, value) => {
                const newAmenityIcons = [...amenityIcons];
                newAmenityIcons[index].value = value;
                setAmenityIcons(newAmenityIcons);
            };

            const handlePrint = () => {
                window.print();
            };

            const handleDownloadPDF = () => {
                window.print();
            };

            const handleReset = () => {
                if (confirm('Are you sure you want to reset all fields?')) {
                    setPropertyData(initialData);
                }
            };

            const toggleCleanView = () => {
                setIsCleanView(!isCleanView);
            };

            const toggleSection = (section) => {
                setExpandedSections(prev => ({
                    ...prev,
                    [section]: !prev[section]
                }));
            };

            // Preset management
            const savePreset = () => {
                const name = prompt('Enter a name for this preset:');
                if (name && name.trim()) {
                    const newPreset = {
                        id: Date.now(),
                        name: name.trim(),
                        data: propertyData,
                        timestamp: Date.now()
                    };
                    const newPresets = [...presets, newPreset];
                    setPresets(newPresets);
                    localStorage.setItem('flyer-presets', JSON.stringify(newPresets));
                }
            };

            const loadPreset = (preset) => {
                if (confirm(`Load preset "${preset.name}"? Current changes will be lost.`)) {
                    setPropertyData(preset.data);
                }
            };

            const deletePreset = (id) => {
                if (confirm('Delete this preset?')) {
                    const newPresets = presets.filter(p => p.id !== id);
                    setPresets(newPresets);
                    localStorage.setItem('flyer-presets', JSON.stringify(newPresets));
                }
            };

            const downloadAsImage = async () => {
                setIsCleanView(true);
                
                setTimeout(async () => {
                    try {
                        const flyer = document.querySelector('.flyer-container');
                        flyer.offsetHeight;
                        
                        const canvas = await html2canvas(flyer, {
                            scale: 3,
                            useCORS: true,
                            allowTaint: true,
                            backgroundColor: '#ffffff',
                            logging: false,
                            windowWidth: flyer.scrollWidth,
                            windowHeight: flyer.scrollHeight,
                            scrollX: 0,
                            scrollY: 0,
                            onclone: (clonedDoc) => {
                                const clonedFlyer = clonedDoc.querySelector('.flyer-container');
                                clonedFlyer.style.webkitFontSmoothing = 'antialiased';
                                clonedFlyer.style.mozOsxFontSmoothing = 'grayscale';
                                
                                const inputs = clonedFlyer.querySelectorAll('input[type="text"], textarea');
                                inputs.forEach(input => {
                                    const span = clonedDoc.createElement('span');
                                    span.textContent = input.value;
                                    span.style.cssText = window.getComputedStyle(input).cssText;
                                    span.style.border = 'none';
                                    span.style.background = 'transparent';
                                    span.style.whiteSpace = 'pre-wrap';
                                    span.style.wordWrap = 'break-word';
                                    span.style.display = 'inline-block';
                                    input.parentNode.replaceChild(span, input);
                                });
                                
                                const editables = clonedFlyer.querySelectorAll('[contenteditable]');
                                editables.forEach(editable => {
                                    editable.removeAttribute('contenteditable');
                                });
                            }
                        });
                        
                        const link = document.createElement('a');
                        link.download = `property-flyer-${Date.now()}.png`;
                        link.href = canvas.toDataURL('image/png', 1.0);
                        link.click();
                        
                        setIsCleanView(false);
                    } catch (error) {
                        console.error('Export failed:', error);
                        alert('Export failed. Please try Print to PDF instead.');
                        setIsCleanView(false);
                    }
                }, 100);
            };

            const downloadMultiFormat = async (format) => {
                const formats = {
                    instagram: { 
                        width: 1080, 
                        height: 1080, 
                        scale: 6,
                        name: 'instagram-post',
                        captureHeight: null
                    },
                    facebook: {
                        width: 1200,
                        height: 630,
                        scale: 8,
                        name: 'facebook-post',
                        captureHeight: 850
                    },
                    print: { 
                        width: 2550, 
                        height: 3300, 
                        scale: 4,
                        name: 'print-flyer',
                        captureHeight: null
                    }
                };

                const spec = formats[format];
                if (!spec) return;

                setIsCleanView(true);
                
                setTimeout(async () => {
                    try {
                        const flyer = document.querySelector('.flyer-container');
                        const flyerRect = flyer.getBoundingClientRect();
                        
                        const captureWidth = flyerRect.width;
                        const captureHeight = spec.captureHeight || flyerRect.height;
                        
                        const canvas = await html2canvas(flyer, {
                            scale: spec.scale,
                            useCORS: true,
                            allowTaint: true,
                            backgroundColor: '#ffffff',
                            logging: false,
                            width: captureWidth,
                            height: captureHeight,
                            x: 0,
                            y: 0,
                            imageTimeout: 0,
                            removeContainer: true,
                            onclone: (clonedDoc) => {
                                const clonedFlyer = clonedDoc.querySelector('.flyer-container');
                                
                                clonedFlyer.style.fontSmooth = 'always';
                                clonedFlyer.style.webkitFontSmoothing = 'antialiased';
                                clonedFlyer.style.mozOsxFontSmoothing = 'grayscale';
                                clonedFlyer.style.textRendering = 'optimizeLegibility';
                                clonedFlyer.style.imageRendering = 'high-quality';
                                
                                const inputs = clonedFlyer.querySelectorAll('input[type="text"], textarea');
                                inputs.forEach(input => {
                                    const span = clonedDoc.createElement('span');
                                    span.textContent = input.value;
                                    span.style.cssText = window.getComputedStyle(input).cssText;
                                    span.style.border = 'none';
                                    span.style.background = 'transparent';
                                    span.style.whiteSpace = 'pre-wrap';
                                    span.style.display = 'inline-block';
                                    span.style.webkitFontSmoothing = 'antialiased';
                                    span.style.textRendering = 'optimizeLegibility';
                                    input.parentNode.replaceChild(span, input);
                                });
                                
                                const editables = clonedFlyer.querySelectorAll('[contenteditable]');
                                editables.forEach(editable => {
                                    editable.removeAttribute('contenteditable');
                                    editable.style.webkitFontSmoothing = 'antialiased';
                                    editable.style.textRendering = 'optimizeLegibility';
                                });
                            }
                        });

                        const finalCanvas = document.createElement('canvas');
                        finalCanvas.width = spec.width;
                        finalCanvas.height = spec.height;
                        const ctx = finalCanvas.getContext('2d', { 
                            alpha: false,
                            desynchronized: false,
                            willReadFrequently: false
                        });
                        
                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';
                        ctx.fillStyle = '#ffffff';
                        ctx.fillRect(0, 0, spec.width, spec.height);

                        let drawWidth, drawHeight, offsetX, offsetY;
                        
                        if (format === 'facebook') {
                            const sourceAspect = canvas.width / canvas.height;
                            const targetAspect = spec.width / spec.height;
                            
                            if (sourceAspect > targetAspect) {
                                drawHeight = spec.height;
                                drawWidth = drawHeight * sourceAspect;
                                offsetX = -(drawWidth - spec.width) / 2;
                                offsetY = 0;
                            } else {
                                drawWidth = spec.width;
                                drawHeight = drawWidth / sourceAspect;
                                offsetX = 0;
                                offsetY = 0;
                            }
                        } else {
                            const fitScale = Math.min(
                                spec.width / canvas.width,
                                spec.height / canvas.height
                            );
                            drawWidth = canvas.width * fitScale;
                            drawHeight = canvas.height * fitScale;
                            offsetX = (spec.width - drawWidth) / 2;
                            offsetY = (spec.height - drawHeight) / 2;
                        }

                        ctx.drawImage(canvas, offsetX, offsetY, drawWidth, drawHeight);

                        const link = document.createElement('a');
                        link.download = `${spec.name}-${Date.now()}.png`;
                        link.href = finalCanvas.toDataURL('image/png', 1.0);
                        link.click();
                        
                        setIsCleanView(false);
                    } catch (error) {
                        console.error('Multi-format export failed:', error);
                        alert('Export failed. Please try again.');
                        setIsCleanView(false);
                    }
                }, 300);
            };

            const batchExport = async () => {
                setBatchExporting(true);
                setBatchProgress(0);
                
                const formats = ['instagram', 'facebook', 'print'];
                
                for (let i = 0; i < formats.length; i++) {
                    await downloadMultiFormat(formats[i]);
                    setBatchProgress(((i + 1) / formats.length) * 100);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                setBatchExporting(false);
                alert('All formats exported successfully!');
            };

            const copyToClipboard = async () => {
                setIsCleanView(true);
                
                setTimeout(async () => {
                    try {
                        const flyer = document.querySelector('.flyer-container');
                        const canvas = await html2canvas(flyer, {
                            scale: 3,
                            useCORS: true,
                            backgroundColor: '#ffffff',
                            onclone: (clonedDoc) => {
                                const clonedFlyer = clonedDoc.querySelector('.flyer-container');
                                clonedFlyer.style.webkitFontSmoothing = 'antialiased';
                                
                                const inputs = clonedFlyer.querySelectorAll('input[type="text"], textarea');
                                inputs.forEach(input => {
                                    const span = clonedDoc.createElement('span');
                                    span.textContent = input.value;
                                    span.style.cssText = window.getComputedStyle(input).cssText;
                                    span.style.border = 'none';
                                    span.style.background = 'transparent';
                                    input.parentNode.replaceChild(span, input);
                                });
                            }
                        });
                        
                        canvas.toBlob(async (blob) => {
                            try {
                                await navigator.clipboard.write([
                                    new ClipboardItem({ 'image/png': blob })
                                ]);
                                alert('Flyer copied to clipboard!');
                            } catch (err) {
                                alert('Copy to clipboard not supported. Please use Download options.');
                            }
                            setIsCleanView(false);
                        });
                    } catch (error) {
                        console.error('Copy failed:', error);
                        alert('Copy failed. Please try another export method.');
                        setIsCleanView(false);
                    }
                }, 100);
            };

            return (
                <>
                    {/* Auto-save indicator */}
                    <div className={`autosave-indicator ${saveStatus}`}>
                        {saveStatus === 'saving' && (
                            <>
                                <i className="fas fa-spinner fa-spin"></i>
                                <span>Saving...</span>
                            </>
                        )}
                        {saveStatus === 'saved' && (
                            <>
                                <i className="fas fa-check"></i>
                                <span>All changes saved</span>
                            </>
                        )}
                        {saveStatus === 'error' && (
                            <>
                                <i className="fas fa-exclamation-triangle"></i>
                                <span>Save failed</span>
                            </>
                        )}
                    </div>

                    {/* Batch export progress */}
                    {batchExporting && (
                        <div className="batch-export-progress">
                            <h3 className="text-lg font-bold mb-2">Exporting All Formats...</h3>
                            <p className="text-sm text-gray-600 mb-2">Please wait while we generate your files</p>
                            <div className="progress-bar">
                                <div className="progress-bar-fill" style={{width: `${batchProgress}%`}}></div>
                            </div>
                            <p className="text-xs text-gray-500 mt-2 text-center">{Math.round(batchProgress)}%</p>
                        </div>
                    )}

                    {/* Keyboard shortcuts modal */}
                    {showShortcuts && (
                        <div className="shortcuts-modal" onClick={() => setShowShortcuts(false)}>
                            <div className="shortcuts-content" onClick={(e) => e.stopPropagation()}>
                                <h3 className="text-xl font-bold mb-4">Keyboard Shortcuts</h3>
                                <div>
                                    <div className="shortcut-item">
                                        <span>Undo</span>
                                        <span className="shortcut-key">Ctrl/Cmd + Z</span>
                                    </div>
                                    <div className="shortcut-item">
                                        <span>Redo</span>
                                        <span className="shortcut-key">Ctrl/Cmd + Shift + Z</span>
                                    </div>
                                    <div className="shortcut-item">
                                        <span>Print</span>
                                        <span className="shortcut-key">Ctrl/Cmd + P</span>
                                    </div>
                                    <div className="shortcut-item">
                                        <span>Toggle Clean View</span>
                                        <span className="shortcut-key">Ctrl/Cmd + E</span>
                                    </div>
                                    <div className="shortcut-item">
                                        <span>Show Shortcuts</span>
                                        <span className="shortcut-key">?</span>
                                    </div>
                                </div>
                                <button 
                                    className="btn btn-primary mt-4"
                                    onClick={() => setShowShortcuts(false)}
                                >
                                    Close
                                </button>
                            </div>
                        </div>
                    )}

                    <div className="controls-panel">
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px'}}>
                            <h3 className="text-sm font-bold text-gray-800">Enhanced Controls</h3>
                            <button 
                                onClick={() => setShowShortcuts(true)}
                                style={{
                                    background: 'none',
                                    border: 'none',
                                    cursor: 'pointer',
                                    fontSize: '16px',
                                    color: '#6b7280'
                                }}
                                title="Keyboard Shortcuts"
                            >
                                <i className="fas fa-keyboard"></i>
                            </button>
                        </div>

                        {/* History Controls */}
                        <div className="history-controls">
                            <button 
                                className="btn history-btn"
                                onClick={undo}
                                disabled={!canUndo}
                                style={{background: canUndo ? '#6366f1' : '#d1d5db', color: 'white'}}
                            >
                                <i className="fas fa-undo"></i>
                                <span>Undo</span>
                            </button>
                            <button 
                                className="btn history-btn"
                                onClick={redo}
                                disabled={!canRedo}
                                style={{background: canRedo ? '#6366f1' : '#d1d5db', color: 'white'}}
                            >
                                <i className="fas fa-redo"></i>
                                <span>Redo</span>
                            </button>
                        </div>
                        
                        {/* Logo Section */}
                        <div className="collapsible-section">
                            <div className="collapsible-header" onClick={() => toggleSection('logo')}>
                                <div className="collapsible-header-title">
                                    <i className="fas fa-image"></i>
                                    <span>Company Logo</span>
                                </div>
                                <i className={`fas fa-chevron-down collapsible-header-icon ${expandedSections.logo ? 'open' : ''}`}></i>
                            </div>
                            {expandedSections.logo && (
                                <div className="collapsible-content">
                                    <div 
                                        onClick={() => triggerFileInput(logoRef)}
                                        onDragOver={handleDragOver}
                                        onDragLeave={handleDragLeave}
                                        onDrop={handleDrop('logo')}
                                        style={{
                                            cursor: 'pointer',
                                            padding: '15px',
                                            background: 'white',
                                            borderRadius: '6px',
                                            border: '2px dashed #d1d5db',
                                            display: 'flex',
                                            flexDirection: 'column',
                                            alignItems: 'center',
                                            gap: '8px',
                                            transition: 'all 0.2s'
                                        }}
                                        className="logo-upload-box"
                                    >
                                        {propertyData.logo ? (
                                            <>
                                                <img 
                                                    src={propertyData.logo} 
                                                    alt="Current Logo" 
                                                    style={{maxHeight: '50px', maxWidth: '120px', objectFit: 'contain'}}
                                                />
                                                <p className="text-xs text-gray-500">Click or drag to change</p>
                                            </>
                                        ) : (
                                            <>
                                                <i className="fas fa-upload text-2xl text-gray-400"></i>
                                                <p className="text-xs text-gray-500">Click or drag logo here</p>
                                                <p className="text-xs text-gray-400">PNG, JPG, WebP</p>
                                            </>
                                        )}
                                    </div>
                                    <input 
                                        type="file" 
                                        style={{display: 'none'}}
                                        accept="image/png,image/jpeg,image/jpg,image/webp"
                                        onChange={(e) => handleImageUpload('logo', e)}
                                        ref={logoRef}
                                    />
                                    
                                    <div style={{marginTop: '12px'}}>
                                        <div style={{marginBottom: '8px'}}>
                                            <label style={{display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '4px'}}>
                                                <span className="text-xs text-gray-600">Height: {propertyData.logoHeight}px</span>
                                            </label>
                                            <input 
                                                type="range" 
                                                min="15" 
                                                max="200" 
                                                value={propertyData.logoHeight}
                                                onChange={(e) => handleInputChange('logoHeight', parseInt(e.target.value))}
                                                style={{width: '100%', cursor: 'pointer'}}
                                            />
                                        </div>
                                        <div>
                                            <label style={{display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '4px'}}>
                                                <span className="text-xs text-gray-600">Width: {propertyData.logoWidth}px</span>
                                            </label>
                                            <input 
                                                type="range" 
                                                min="40" 
                                                max="440" 
                                                value={propertyData.logoWidth}
                                                onChange={(e) => handleInputChange('logoWidth', parseInt(e.target.value))}
                                                style={{width: '100%', cursor: 'pointer'}}
                                            />
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* QR Code Section */}
                        <div className="collapsible-section">
                            <div className="collapsible-header" onClick={() => toggleSection('qr')}>
                                <div className="collapsible-header-title">
                                    <i className="fas fa-qrcode"></i>
                                    <span>QR Code</span>
                                </div>
                                <i className={`fas fa-chevron-down collapsible-header-icon ${expandedSections.qr ? 'open' : ''}`}></i>
                            </div>
                            {expandedSections.qr && (
                                <div className="collapsible-content">
                                    <input 
                                        type="text" 
                                        className="edit-field text-xs"
                                        placeholder="Enter property URL"
                                        value={propertyData.qrCodeUrl}
                                        onChange={(e) => handleInputChange('qrCodeUrl', e.target.value)}
                                        style={{marginBottom: '10px', fontSize: '11px'}}
                                    />
                                    <input 
                                        type="text" 
                                        className="edit-field text-xs"
                                        placeholder="QR Code Label"
                                        value={propertyData.qrCodeLabel}
                                        onChange={(e) => handleInputChange('qrCodeLabel', e.target.value)}
                                        style={{marginBottom: '10px', fontSize: '11px'}}
                                    />
                                    {propertyData.qrCodeUrl && (
                                        <div className="qr-code-container">
                                            <div id="qr-code"></div>
                                            <p className="text-xs text-gray-500">Scan to view listing</p>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>

                        {/* Export Section */}
                        <div className="collapsible-section">
                            <div className="collapsible-header" onClick={() => toggleSection('export')}>
                                <div className="collapsible-header-title">
                                    <i className="fas fa-download"></i>
                                    <span>Export Options</span>
                                </div>
                                <i className={`fas fa-chevron-down collapsible-header-icon ${expandedSections.export ? 'open' : ''}`}></i>
                            </div>
                            {expandedSections.export && (
                                <div className="collapsible-content">
                                    <button className="btn btn-primary" onClick={handlePrint}>
                                        <i className="fas fa-print mr-1"></i>
                                        Print
                                    </button>
                                    <button className="btn btn-secondary" onClick={handleDownloadPDF}>
                                        <i className="fas fa-file-pdf mr-1"></i>
                                        Save PDF
                                    </button>
                                    
                                    <div style={{marginTop: '10px', paddingTop: '10px', borderTop: '1px solid #e5e7eb'}}>
                                        <p className="text-xs font-semibold text-gray-700 mb-2">Quick Export</p>
                                        <button 
                                            className="btn" 
                                            style={{background: '#8b5cf6', color: 'white', fontSize: '11px', padding: '6px 10px'}}
                                            onClick={downloadAsImage}
                                        >
                                            <i className="fas fa-image mr-1"></i>
                                            Download PNG
                                        </button>
                                        <button 
                                            className="btn" 
                                            style={{background: '#06b6d4', color: 'white', fontSize: '11px', padding: '6px 10px'}}
                                            onClick={copyToClipboard}
                                        >
                                            <i className="fas fa-copy mr-1"></i>
                                            Copy to Clipboard
                                        </button>
                                        <button 
                                            className="btn" 
                                            style={{background: '#10b981', color: 'white', fontSize: '11px', padding: '6px 10px'}}
                                            onClick={toggleCleanView}
                                        >
                                            <i className={`fas ${isCleanView ? 'fa-edit' : 'fa-eye'} mr-1`}></i>
                                            {isCleanView ? 'Show Editor' : 'Preview'}
                                        </button>
                                    </div>

                                    <div style={{marginTop: '10px', paddingTop: '10px', borderTop: '1px solid #e5e7eb'}}>
                                        <p className="text-xs font-semibold text-gray-700 mb-2">
                                            <i className="fas fa-magic mr-1"></i>
                                            Multi-Format
                                        </p>
                                        <button 
                                            className="btn" 
                                            style={{background: '#E4405F', color: 'white', fontSize: '11px', padding: '6px 10px'}}
                                            onClick={() => downloadMultiFormat('instagram')}
                                        >
                                            <i className="fab fa-instagram mr-1"></i>
                                            Instagram
                                        </button>
                                        <button 
                                            className="btn" 
                                            style={{background: '#1877F2', color: 'white', fontSize: '11px', padding: '6px 10px'}}
                                            onClick={() => downloadMultiFormat('facebook')}
                                        >
                                            <i className="fab fa-facebook mr-1"></i>
                                            Facebook
                                        </button>
                                        <button 
                                            className="btn" 
                                            style={{background: '#7c3aed', color: 'white', fontSize: '11px', padding: '6px 10px'}}
                                            onClick={() => downloadMultiFormat('print')}
                                        >
                                            <i className="fas fa-print mr-1"></i>
                                            Print Size
                                        </button>
                                        <button 
                                            className="btn" 
                                            style={{background: '#f59e0b', color: 'white', fontSize: '11px', padding: '6px 10px', fontWeight: 'bold'}}
                                            onClick={batchExport}
                                        >
                                            <i className="fas fa-layer-group mr-1"></i>
                                            Export All Formats
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Presets Section */}
                        <div className="collapsible-section">
                            <div className="collapsible-header" onClick={() => toggleSection('presets')}>
                                <div className="collapsible-header-title">
                                    <i className="fas fa-save"></i>
                                    <span>Templates ({presets.length})</span>
                                </div>
                                <i className={`fas fa-chevron-down collapsible-header-icon ${expandedSections.presets ? 'open' : ''}`}></i>
                            </div>
                            {expandedSections.presets && (
                                <div className="collapsible-content">
                                    <button 
                                        className="btn btn-secondary"
                                        onClick={savePreset}
                                        style={{marginBottom: '10px'}}
                                    >
                                        <i className="fas fa-plus mr-1"></i>
                                        Save Current as Template
                                    </button>
                                    
                                    {presets.length > 0 ? (
                                        <div>
                                            {presets.map(preset => (
                                                <div key={preset.id} className="preset-item">
                                                    <span className="font-semibold">{preset.name}</span>
                                                    <div className="preset-actions">
                                                        <button 
                                                            className="preset-btn"
                                                            onClick={() => loadPreset(preset)}
                                                            title="Load"
                                                        >
                                                            <i className="fas fa-upload text-blue-600"></i>
                                                        </button>
                                                        <button 
                                                            className="preset-btn"
                                                            onClick={() => deletePreset(preset.id)}
                                                            title="Delete"
                                                        >
                                                            <i className="fas fa-trash text-red-600"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    ) : (
                                        <p className="text-xs text-gray-500 text-center py-2">No saved templates</p>
                                    )}
                                </div>
                            )}
                        </div>

                        {/* Features Section */}
                        <div className="collapsible-section">
                            <div className="collapsible-header" onClick={() => toggleSection('features')}>
                                <div className="collapsible-header-title">
                                    <i className="fas fa-star"></i>
                                    <span>Features ({customFeatures.length}/10)</span>
                                </div>
                                <i className={`fas fa-chevron-down collapsible-header-icon ${expandedSections.features ? 'open' : ''}`}></i>
                            </div>
                            {expandedSections.features && (
                                <div className="collapsible-content">
                                    <div className="feature-icon-grid">
                                        {customFeatures.map((feature, index) => (
                                            <div key={index} className="feature-icon-item">
                                                <button 
                                                    className="remove-icon-btn"
                                                    onClick={() => removeCustomFeature(index)}
                                                >
                                                    <i className="fas fa-times"></i>
                                                </button>
                                                <div className="feature-icon-display">
                                                    <i className={`fas ${feature.icon}`}></i>
                                                </div>
                                                <div className="feature-icon-label">{feature.label}</div>
                                            </div>
                                        ))}
                                        {customFeatures.length < 10 && (
                                            <div className="feature-icon-item add-icon" onClick={openIconSelector}>
                                                <div className="feature-icon-display">
                                                    <i className="fas fa-plus"></i>
                                                </div>
                                                <div className="feature-icon-label">Add Feature</div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>

                        <button className="btn" style={{background: '#ef4444', color: 'white', marginTop: '10px'}} onClick={handleReset}>
                            <i className="fas fa-redo mr-1"></i>
                            Reset All
                        </button>
                        
                        <div className="mt-3 p-2 bg-blue-50 rounded text-xs text-gray-600">
                            <p className="font-semibold mb-1 text-xs">ð¡ Pro Tips:</p>
                            <ul className="list-disc pl-3 space-y-0.5 text-xs">
                                <li>Drag & drop images</li>
                                <li>Press ? for shortcuts</li>
                                <li>Auto-saves every 2 sec</li>
                                <li>Undo/Redo: Ctrl+Z / Ctrl+Shift+Z</li>
                            </ul>
                        </div>
                    </div>

                    {/* Icon Selector Modal */}
                    {showIconSelector && (
                        <div className="icon-selector-modal" onClick={() => setShowIconSelector(false)}>
                            <div className="icon-selector-content" onClick={(e) => e.stopPropagation()}>
                                <h3 className="text-lg font-bold mb-4">Select a Feature</h3>
                                <div>
                                    {availableIcons.map((iconData, index) => (
                                        <div 
                                            key={index} 
                                            className="icon-option"
                                            onClick={() => addCustomFeature(iconData)}
                                        >
                                            <i className={`fas ${iconData.icon}`}></i>
                                            <span>{iconData.label}</span>
                                        </div>
                                    ))}
                                </div>
                                <button 
                                    className="btn btn-primary mt-4"
                                    onClick={() => setShowIconSelector(false)}
                                >
                                    Close
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Amenity Icon Selector Modal */}
                    {showAmenityIconSelector && (
                        <div className="icon-selector-modal" onClick={() => setShowAmenityIconSelector(false)}>
                            <div className="icon-selector-content" onClick={(e) => e.stopPropagation()}>
                                <h3 className="text-lg font-bold mb-4">Change Amenity Icon</h3>
                                <div>
                                    {availableIcons.map((iconData, index) => (
                                        <div 
                                            key={index} 
                                            className="icon-option"
                                            onClick={() => changeAmenityIcon(iconData)}
                                        >
                                            <i className={`fas ${iconData.icon}`}></i>
                                            <span>{iconData.label}</span>
                                        </div>
                                    ))}
                                </div>
                                <button 
                                    className="btn btn-primary mt-4"
                                    onClick={() => setShowAmenityIconSelector(false)}
                                >
                                    Close
                                </button>
                            </div>
                        </div>
                    )}

                    <div className={`flyer-container ${isCleanView ? 'clean-view' : ''}`}>
                        {/* Hero Section with Image */}
                        <div style={{position: 'relative', width: '100%', height: '500px', overflow: 'hidden'}}>
                            <div 
                                className="image-upload-btn" 
                                style={{
                                    position: 'absolute',
                                    top: 0,
                                    left: 0,
                                    width: '100%',
                                    height: '100%',
                                    cursor: 'pointer',
                                    zIndex: 1
                                }}
                                onClick={() => triggerFileInput(heroImageRef)}
                                onDragOver={handleDragOver}
                                onDragLeave={handleDragLeave}
                                onDrop={handleDrop('heroImage')}
                            >
                                {propertyData.heroImage ? (
                                    <img src={propertyData.heroImage} alt="Property" style={{width: '100%', height: '100%', objectFit: 'cover'}} />
                                ) : (
                                    <div style={{
                                        width: '100%',
                                        height: '100%',
                                        background: 'linear-gradient(135deg, #3b82f6 0%, #1e40af 100%)',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        color: 'white'
                                    }}>
                                        <div className="text-center">
                                            <i className="fas fa-camera text-6xl mb-4 opacity-50"></i>
                                            <p className="text-xl">Click or Drag Hero Image</p>
                                            <p className="text-sm opacity-75 mt-2">JPG, PNG, or WebP (max 10MB)</p>
                                        </div>
                                    </div>
                                )}
                                <input 
                                    type="file" 
                                    style={{display: 'none'}}
                                    accept="image/jpeg,image/jpg,image/png,image/webp"
                                    onChange={(e) => handleImageUpload('heroImage', e)}
                                    ref={heroImageRef}
                                />
                                {propertyData.heroImage && (
                                    <div className="upload-overlay">
                                        <div className="text-white text-center">
                                            <i className="fas fa-camera text-4xl mb-2"></i>
                                            <p>Change Image</p>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Blue Gradient Overlay */}
                            <div style={{
                                position: 'absolute',
                                bottom: 0,
                                left: 0,
                                width: '100%',
                                height: '180px',
                                background: 'linear-gradient(to top, rgba(30, 58, 138, 0.98) 0%, rgba(30, 58, 138, 0.95) 35%, rgba(30, 58, 138, 0.70) 65%, transparent 100%)',
                                zIndex: 5
                            }}>
                                {/* Logo */}
                                <div style={{
                                    position: 'absolute',
                                    top: '12px',
                                    left: '0',
                                    background: 'white',
                                    padding: '8px 14px',
                                    borderRadius: '0 20% 20% 0',
                                    boxShadow: '0 2px 8px rgba(0,0,0,0.2)',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    width: '120px',
                                    height: '54px',
                                    position: 'relative',
                                    overflow: 'visible'
                                }}>
                                    <img 
                                        src={propertyData.logo} 
                                        alt="Company Logo" 
                                        style={{
                                            height: `${propertyData.logoHeight}px`, 
                                            width: `${propertyData.logoWidth}px`, 
                                            objectFit: 'contain',
                                            maxWidth: 'none',
                                            maxHeight: 'none'
                                        }}
                                    />
                                </div>

                                {/* Address and MLS */}
                                <div style={{
                                    position: 'absolute',
                                    bottom: '18px',
                                    left: '30px',
                                    color: 'white',
                                    maxWidth: '50%'
                                }}>
                                    <div
                                        className="edit-field edit-field-white"
                                        contentEditable={!isCleanView}
                                        onBlur={(e) => handleInputChange('address', e.currentTarget.textContent)}
                                        suppressContentEditableWarning={true}
                                        style={{fontSize: '32px', fontWeight: 'bold', color: 'white', background: 'transparent', border: 'none', lineHeight: '1.1', marginBottom: '6px', outline: 'none', fontFamily: 'system-ui, -apple-system, "Segoe UI", "Roboto", "Helvetica Neue", Arial, sans-serif'}}
                                    >
                                        {propertyData.address}
                                    </div>
                                    <div style={{display: 'flex', alignItems: 'baseline', gap: '8px'}}>
                                        <div style={{fontSize: '10px', opacity: 0.9, textTransform: 'uppercase', letterSpacing: '0.5px'}}>MLS</div>
                                        <div
                                            className="edit-field edit-field-white"
                                            contentEditable={!isCleanView}
                                            onBlur={(e) => handleInputChange('mls', e.currentTarget.textContent)}
                                            suppressContentEditableWarning={true}
                                            style={{fontSize: '16px', fontWeight: '600', color: 'white', background: 'transparent', border: 'none', outline: 'none', display: 'inline-block', fontFamily: 'system-ui, -apple-system, "Segoe UI", "Roboto", "Helvetica Neue", Arial, sans-serif'}}
                                        >
                                            {propertyData.mls}
                                        </div>
                                    </div>
                                </div>

                                {/* Pricing */}
                                <div style={{
                                    position: 'absolute',
                                    bottom: '18px',
                                    right: '30px',
                                    color: 'white',
                                    textAlign: 'right'
                                }}>
                                    <div style={{marginBottom: '8px', display: 'flex', alignItems: 'baseline', justifyContent: 'flex-end', gap: '10px'}}>
                                        <div style={{fontSize: '28px', opacity: 0.9, textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: 'bold', fontFamily: 'system-ui, -apple-system, "Segoe UI", "Roboto", "Helvetica Neue", Arial, sans-serif'}}>USD</div>
                                        <div style={{display: 'flex', alignItems: 'center'}}>
                                            <span style={{fontSize: '28px', fontWeight: 'bold', marginRight: '6px', fontFamily: 'system-ui, -apple-system, "Segoe UI", "Roboto", "Helvetica Neue", Arial, sans-serif'}}>$</span>
                                            <div
                                                className="edit-field edit-field-white"
                                                contentEditable={!isCleanView}
                                                onBlur={(e) => handleInputChange('priceUSD', e.currentTarget.textContent)}
                                                suppressContentEditableWarning={true}
                                                style={{fontSize: '28px', fontWeight: 'bold', textAlign: 'right', color: 'white', minWidth: '170px', maxWidth: '250px', background: 'transparent', border: 'none', fontFamily: 'system-ui, -apple-system, "Segoe UI", "Roboto", "Helvetica Neue", Arial, sans-serif', outline: 'none', display: 'inline-block'}}
                                            >
                                                {propertyData.priceUSD}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div style={{marginBottom: '8px', display: 'flex', alignItems: 'baseline', justifyContent: 'flex-end', gap: '10px'}}>
                                        <div style={{fontSize: '9px', opacity: 0.85, textTransform: 'uppercase', letterSpacing: '0.5px', fontFamily: 'system-ui, -apple-system, "Segoe UI", "Roboto", "Helvetica Neue", Arial, sans-serif'}}>MXN</div>
                                        <div style={{display: 'flex', alignItems: 'center'}}>
                                            <span style={{fontSize: '14px', marginRight: '4px', fontFamily: 'system-ui, -apple-system, "Segoe UI", "Roboto", "Helvetica Neue", Arial, sans-serif'}}>$</span>
                                            <div
                                                className="edit-field edit-field-white"
                                                contentEditable={!isCleanView}
                                                onBlur={(e) => handleInputChange('priceMXN', e.currentTarget.textContent)}
                                                suppressContentEditableWarning={true}
                                                style={{fontSize: '14px', textAlign: 'right', color: 'white', minWidth: '140px', maxWidth: '200px', background: 'transparent', border: 'none', fontFamily: 'system-ui, -apple-system, "Segoe UI", "Roboto", "Helvetica Neue", Arial, sans-serif', outline: 'none', display: 'inline-block'}}
                                            >
                                                {propertyData.priceMXN}
                                            </div>
                                        </div>
                                    </div>

                                    <div style={{
                                        width: '60%',
                                        height: '1px',
                                        background: 'rgba(255, 255, 255, 0.3)',
                                        marginBottom: '8px',
                                        marginTop: '4px',
                                        marginLeft: 'auto'
                                    }}></div>

                                    <div style={{display: 'flex', gap: '18px', fontSize: '13px', justifyContent: 'flex-end', alignItems: 'flex-end'}}>
                                        <div style={{textAlign: 'right'}}>
                                            <div style={{opacity: 0.8, fontSize: '9px', marginBottom: '2px', textTransform: 'uppercase', letterSpacing: '0.5px'}}>Size</div>
                                            <div style={{display: 'flex', alignItems: 'baseline', justifyContent: 'flex-end'}}>
                                                <input 
                                                    type="text" 
                                                    className="edit-field edit-field-white"
                                                    style={{fontWeight: '600', fontSize: '13px', width: '60px', textAlign: 'right', color: 'white', background: 'transparent', border: 'none'}}
                                                    value={propertyData.size}
                                                    onChange={(e) => handleInputChange('size', e.target.value)}
                                                />
                                                <span style={{marginLeft: '4px', fontSize: '10px', opacity: 0.9}}>SQFT</span>
                                            </div>
                                        </div>
                                        <div style={{textAlign: 'right'}}>
                                            <div style={{opacity: 0.8, fontSize: '9px', marginBottom: '2px', textTransform: 'uppercase', letterSpacing: '0.5px'}}>Year Built</div>
                                            <input 
                                                type="text" 
                                                className="edit-field edit-field-white"
                                                style={{fontWeight: '600', fontSize: '13px', width: '50px', textAlign: 'right', color: 'white', background: 'transparent', border: 'none'}}
                                                value={propertyData.yearBuilt}
                                                onChange={(e) => handleInputChange('yearBuilt', e.target.value)}
                                            />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Content Section */}
                        <div className="content-section">
                            <div style={{display: 'flex', gap: '16px', width: '100%', maxWidth: '100%'}}>
                                {/* Left: 2x2 Grid */}
                                <div style={{flex: '0 0 66%', display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px'}}>
                                    {[1, 2, 3, 4].map(num => (
                                        <div key={num} style={{minWidth: 0}}>
                                            <div 
                                                className="image-upload-btn" 
                                                style={{height: '185px', borderRadius: '8px', overflow: 'hidden', cursor: 'pointer'}}
                                                onClick={() => triggerFileInput(eval(`image${num}Ref`))}
                                                onDragOver={handleDragOver}
                                                onDragLeave={handleDragLeave}
                                                onDrop={handleDrop(`image${num}`)}
                                            >
                                                {propertyData[`image${num}`] ? (
                                                    <img src={propertyData[`image${num}`]} className="interior-image" alt={`Interior ${num}`} />
                                                ) : (
                                                    <div className="interior-image" style={{display: 'flex', alignItems: 'center', justifyContent: 'center', background: '#f3f4f6', height: '185px'}}>
                                                        <div className="text-center text-gray-400">
                                                            <i className="fas fa-camera text-2xl mb-2"></i>
                                                            <p className="text-xs">Drop or Click</p>
                                                        </div>
                                                    </div>
                                                )}
                                                <input 
                                                    type="file" 
                                                    style={{display: 'none'}}
                                                    accept="image/jpeg,image/jpg,image/png,image/webp"
                                                    onChange={(e) => handleImageUpload(`image${num}`, e)}
                                                    ref={eval(`image${num}Ref`)}
                                                />
                                                {propertyData[`image${num}`] && (
                                                    <div className="upload-overlay">
                                                        <div className="text-white text-center">
                                                            <i className="fas fa-camera text-xl"></i>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                {/* Right: Overview */}
                                <div style={{flex: '0 0 34%', minWidth: 0, overflow: 'hidden'}}>
                                    <div className="unit-overview-section" style={{height: '382px', display: 'flex', flexDirection: 'column', width: '100%', maxWidth: '100%'}}>
                                        <h3 className="text-xs font-bold uppercase tracking-wider text-gray-400 mb-2">Unit Overview</h3>
                                        <div 
                                            className="edit-field edit-field-dark text-xs leading-relaxed flex-1"
                                            contentEditable={!isCleanView}
                                            onBlur={(e) => {
                                                const text = e.currentTarget.textContent;
                                                if (text.length <= 350) {
                                                    handleInputChange('overview', text);
                                                } else {
                                                    const truncated = text.substring(0, 350);
                                                    handleInputChange('overview', truncated);
                                                    e.currentTarget.textContent = truncated;
                                                }
                                            }}
                                            suppressContentEditableWarning={true}
                                            style={{
                                                whiteSpace: 'pre-wrap', 
                                                wordWrap: 'break-word', 
                                                overflowWrap: 'break-word', 
                                                width: '100%', 
                                                maxWidth: '100%', 
                                                boxSizing: 'border-box', 
                                                overflow: 'hidden',
                                                lineHeight: '1.5',
                                                padding: '8px'
                                            }}
                                        >
                                            {propertyData.overview}
                                        </div>
                                        <div className="character-counter" style={{fontSize: '9px', color: '#9ca3af', marginTop: '4px', textAlign: 'right'}}>
                                            {propertyData.overview.length}/350 characters
                                        </div>
                                        <div className="mt-2 text-right">
                                            <input 
                                                type="text" 
                                                className="edit-field edit-field-dark text-xs text-gray-500 text-right"
                                                value={propertyData.location}
                                                onChange={(e) => handleInputChange('location', e.target.value)}
                                                placeholder="Location"
                                                style={{width: '100%', maxWidth: '100%', boxSizing: 'border-box'}}
                                            />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Amenities */}
                            <div className="amenities-section">
                                {amenityIcons.map((amenity, index) => (
                                    <div key={index} className="amenity-item" style={{position: 'relative'}}>
                                        <button 
                                            className="remove-icon-btn"
                                            onClick={() => openAmenityIconSelector(index)}
                                            title="Change icon"
                                        >
                                            <i className="fas fa-sync-alt" style={{fontSize: '10px'}}></i>
                                        </button>
                                        <div className="amenity-icon">
                                            <i className={`fas ${amenity.icon}`}></i>
                                        </div>
                                        <input 
                                            type="text" 
                                            className="edit-field edit-field-dark amenity-value text-center"
                                            style={{width: '40px', margin: '0 auto', fontSize: '22px'}}
                                            value={amenity.value}
                                            onChange={(e) => updateAmenityValue(index, e.target.value)}
                                        />
                                        <div className="amenity-label">{amenity.label}</div>
                                    </div>
                                ))}
                                
                                {/* QR Code in amenities section */}
                                {propertyData.qrCodeUrl && (
                                    <div className="amenity-item" style={{position: 'relative'}}>
                                        <div style={{
                                            display: 'flex',
                                            flexDirection: 'column',
                                            alignItems: 'center',
                                            justifyContent: 'center'
                                        }}>
                                            <div id="qr-code-flyer" style={{
                                                display: 'flex',
                                                justifyContent: 'center',
                                                alignItems: 'center',
                                                marginBottom: '3px'
                                            }}></div>
                                            <div className="amenity-label">{propertyData.qrCodeLabel}</div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Footer */}
                        <div className="footer-note">
                            *The property's price will be displayed in the legal currency of the United States of America and also in its equivalent in Mexican Pesos, according to the exchange rate published in the D.O.F. on the day of the sale.
                        </div>
                    </div>
                </>
            );
        }

        ReactDOM.render(<PropertyFlyerEditor />, document.getElementById('root'));
    </script>
</body>
</html>
